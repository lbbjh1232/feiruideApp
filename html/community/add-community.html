<!DOCTYPE html>
<html>

	<head> 
		<meta charset="utf-8"> 
		<title>通讯录</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script type="text/javascript">
			document.write('<script src="../../js/fix.js?rd=?rd=' + Math.random() + '"><\/script>');
		</script>   
		  
		<script type="text/javascript">
			link(['../../css/mui.min.css','../../css/common.css','../../css/icon.css','../../css/community/add-community-copy.css'],true);   
		</script>  
		
	</head>    
   
	<body contextmenu="return false;">
		<div id="app">
		<header class="mui-bar mui-bar-nav no-shadow">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class=" iconfont1 mui-title">医保政策&nbsp;</h1>
			<div id="data-from">发布</div>
		</header>
		
		<div class="mui-content"> 
			<div id="content-box">
				<div class="community-title-box">
					<input id="title" type="text" v-model="title"  placeholder="标题" >
				</div>
				
				<content-upload @ongetcontent="getContent" :content="content"></content-upload> 
			
				 
			</div>
			
			<!-- 添加图文按钮 --> 
			<div @tap.stop="addImgText"  id="add-img-text">
				<div class="iconfont1 icon-add-text-img"></div>
				<div class="icon-text-btn">
					添加图文
				</div>
			</div>
			
		</div>
		</div>
		
		
		<script type="text/javascript">
			script(['../../js/mui.min.js','../../js/vue.js','../../js/api.js','../../js/app.js']);
		</script>
		<script type="text/x-template" id="content-template">
			<div>
				<template v-for="(item,index) in contentCopy">
					<div class="community-content-box">
						<div class="community-content-text">
							<textarea @focusin="textFocusIn" @focusout="textFocusOut" v-model="item.text" :data-index="index" rows="4" placeholder="输入内容"></textarea>
						</div>
						
						<div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="height:8rem;padding: 0;">
							<div class="mui-scroll" style="position:absolute;height:8rem;">
								
									<div class="mui-control-item" v-for="(items,indexs) in item.url">
										<img :src="items" data-preview-src="" :data-preview-group="index"/>
										<span @tap.stop.prevent="onDelete(index,indexs)" class="delete iconfont1 icon-community-delete"></span>
									</div>
									
									<!-- 选择上传按钮 -->
									<div @tap.stop="onSelect(index)" v-show="item.url.length < max " class="mui-control-item">
										<div class="weui-uploader__input-box"></div>
									</div>
								 
							</div>
						</div>
						
						<!-- 删除按钮 -->
						<span @tap.stop.prevent="deleteImgText(index)"  v-show="index!==0" class="delete-img-text iconfont1 icon-delete-img-text"></span>
						
					</div>
				</template>
			</div>
		</script>
		<script type="text/javascript">
		mui.init({
			gestureConfig: {
				tap: true,
				doubletap: true,
				longtap: true,
				swipe: true,
				drag: true, 
			}
		});
		if(mui.os.ios){
			// 解决在ios上fixed元素focusin时位置出现错误的问题 
			document.addEventListener('DOMContentLoaded',function(){
				var footerDom = document.querySelector('#add-img-text');
				
				document.addEventListener('focusin', function() {
					footerDom.style.position = 'absolute';
				});
				document.addEventListener('focusout', function() {
					footerDom.style.position = 'fixed';
				});
			});
		}
		
			
		mui.plusReady(function () {
			let maxHeight = window.innerHeight;
			let minHeight = null;
			var contents= {
					template : "#content-template",
					data : function(){
						return {
							contentCopy:[{text:'',url:[]}],
						};
					},
					props:{
						content:Array,
						url:String,
						max:{type : Number,default:8},
						formdata: {type : Object,default : function(){ return {}}},
					},
					watch:{
						content(val){
							this.contentCopy = val
						},
					},
					
					methods:{
						textFocusIn(e){
							document.activeElement.scrollIntoView({
								block: 'start',
								behavior: 'smooth' 
							});
						},
						textFocusOut(){
							plus.webview.currentWebview().setStyle({
								height:minHeight
							})
						},
						onSelect(index){
							this.contentCopy[index].url.push('');
							this.$emit('ongetcontent',{content:this.contentCopy});
						},
						onDelete(outIndex,inIndex){
							this.content[outIndex].url.splice(inIndex,1);
							this.$emit('ongetcontent',{content:this.contentCopy});
						},
						deleteImgText(index){
							this.contentCopy.splice(index,1);
							this.$emit('ongetcontent',{content:this.contentCopy});
						}
					},
				};
			var vm = new Vue({
				el : '#app',
				components:{
					'content-upload':contents
				},
				data:{
					content:[{text:'',url:[]}],
					title:'',
					url:'',
					formdata:{}
				},
				methods:{
					 
					getContent(e){
						this.content = e.content;
					},
					addImgText(){
						if(this.content.length == 6){
							mui.toast('不能再添加了');
							return;
						}
						this.content.push({text:'',url:[]});
						let that = this;
						this.$nextTick(function(){
							mui('.mui-scroll-wrapper').scroll({
							          deceleration: 0.0005,
									  scroll_x:true,
									  scroll_y:false
							});
							// mui.showKeyboard();
							document.getElementsByTagName('textarea')[that.content.length-1].focus();
							
						});
						
					}
				}
			});
			
			mui.statusAndSetAfterBack('dark','#ffffff');
			
			plus.webview.currentWebview().setStyle({
				softinputMode: "adjustResize"
			});
			window.addEventListener('resize',function(){
				console.log(minHeight)
				if(minHeight == null){
					minHeight = window.innerHeight;
					plus.webview.currentWebview().setStyle({
						height:minHeight
					})
				}
			});
				
		});
		</script>
	</body>
</html>