<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>登录</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript">
			document.write('<script src="../../js/fix.js?rd=?rd=' + Math.random() + '"><\/script>');
		</script>
		<script type="text/javascript">
			link(['../../css/mui.min.css',,'../../css/common.css','../../css/my/login.css'],true);
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">用户登录</h1>
		</header>
		<div class="mui-content" id="app">
			<form id='login-form' class="mui-input-group">
				<div class="mui-input-row">
					<label>账号</label>
					<input id='account' type="text" v-model="account" class="mui-input" placeholder="请输入账号">
				</div>
				<div class="mui-input-row">
					<label>密码</label>
					<input id='password' type="password" v-model="password" class="mui-input" placeholder="请输入密码">
				</div>
				<!-- <div class="mui-input-row">
					<label>手机号</label>
					<input id='phone' type="number" v-model="phone" class="mui-input" placeholder="请输入手机号">
				</div> -->
				<div class="mui-input-row">
					<label>图片验证</label>
					<input id='code' type="text" v-model="picNumber" maxlength="4" class="code" placeholder="请输入图片验证码">
					<canvas id="canvas" ></canvas>
				</div>
				<!-- <div class="mui-input-row">
					<label>短信验证</label>
					<input id='smsInput' type="text" v-model="smsNumber" class="code" placeholder="请输入短信验证码">
					<div id="smsCode" v-if="!sending" >{{notice}}</div>
					<div class="sms-sending" v-if="sending" >{{countDown}}s</div>
				</div> -->
			</form>
			<div class="private">
				<div class="mui-input-row mui-checkbox mui-left">
				  <label style="font-size: 1.4rem;">
					  请认真阅读 <span id="agreement">《用户协议》</span>和 <span id="private">
					  	《隐私政策》
					  </span>
					  
					</label>
				  <input name="checkbox1" type="checkbox" v-model="policy">
				</div>
				
			</div>
			
			<div class="mui-content-padded">
				<button id='login' class="mui-btn mui-btn-block mui-btn-primary">登录</button>
				
				<div id="notice">
					说明: 登录账号、密码与药品电子化管理系统账号同步，手机号仅用于接收短信验证码。
				</div>
			</div>
			
		</div>
		
		
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/vue.js"></script>
		<script src="../../js/my/code.js"></script>
		<script src="../../js/api.js"></script> 
		<script src="../../js/app.js"></script> 
		<script type="text/javascript">
			mui.init();
			
			// 挂载实例
			var vm = new Vue({
				el:'#app',
				data:{
					policy:false,
					sending:false,
					countDown:90,
					notice:"获取验证码",
					code:'', 	//图片验证码
					account:'',
					password:'',
					picNumber:'',
					phone:'',
					confirmPhone:'',
					smsNumber:''
				}
			});
			
			// 更新图片验证码
			draw(); //首次执行
			var canvas = document.getElementById('canvas');
			canvas.addEventListener('tap',function(){
				draw();
			});  
			
			
			mui.plusReady(function () {
				//重写mui.back

				var new_back = function(){
					var old_back = mui.back;
					var myview = plus.webview.getWebviewById('html/my.html');
					var messageview = plus.webview.getWebviewById('html/message.html');
					var friendview = plus.webview.getWebviewById('html/friend.html');
					var indexview = plus.webview.getLaunchWebview();
					mui.fire(myview,'loginLoad',{id:1});	//重载个人中心
					mui.fire(indexview,'loginLoad');	//重载消息总数					
					mui.fire(messageview,'loginLoad');	//重载
					mui.fire(friendview,'loginLoad');	//重载好友
					old_back();
					// return true;
					
				}
				
				// 跳转到用户协议和隐私政策
				document.getElementById('agreement').addEventListener("tap",function(){
					var win = '../search-tool/embed.html';
					var title = "用户协议";
					var href = "https://yxt.feiruide.cn/index.php/user/agreement"
					// 创建窗口
					var ws = plus.webview.create(win,win,{scrollIndicator :'none',scalable : false,backButtonAutoControl : 'close',},{title,href})
					ws.show('pop-in');
				})
				document.getElementById('private').addEventListener("tap",function(){
					var win = '../search-tool/embed.html';
					var title = "隐私政策";
					var href = "https://yxt.feiruide.cn/index.php/user/private"
					// 创建窗口
					var ws = plus.webview.create(win,win,{scrollIndicator :'none',scalable : false,backButtonAutoControl : 'close',},{title,href})
					ws.show('pop-in');
				})
				
				
				// 获取短信验证码
				//var sms = document.getElementById('smsCode');
				// sms.addEventListener('tap',function(){
				// 	// 判断手机号是否正确
				// 	if( !vm.phone ){
				// 		mui.toast('请输入手机号');
				// 		return;
				// 	}
				// 	var reg = new RegExp(/^1\d{10}$/);
				// 	if(!reg.test(vm.phone)) {
				// 		mui.toast("手机号格式错误");
				// 		return;
				// 	}
					
				// 	if(!vm.picNumber){
				// 		mui.toast('请输入图片验证码');
				// 		return;
				// 	}
				// 	// 发送验证码
				// 	var res = mui.http_post(API.SMS_CODE,{mobile:vm.phone});
				// 	res.then(res=>{
				// 		if(res.code == 200){
				// 			mui.toast(res.message);
				// 		}else{
				// 			mui.alert(res.message,'提示','确认',function (e) {
				// 			   e.index
				// 			});
				// 			return;
				// 		}
				// 	})
					
				// 	vm.confirmPhone = vm.phone;
				// 	vm.sending = true;
				// 	var time = vm.countDown; 
				// 	// 倒计时
				// 	var setInt = setInterval(function(){
				// 		if( time<=1 ){
				// 			vm.sending = false;
				// 			vm.notice = "重新获取";
				// 			vm.countDown = 90;
				// 			clearInterval(setInt);
				// 		}else{
				// 			vm.countDown = --time;
				// 		}
				// 	},1000)
				// })
				
				
			    // 提交注册
			    var submit = document.getElementById('login');
			    submit.addEventListener('tap',function(){
					if(!vm.policy){
						mui.toast('请阅读《用户协议》及《隐私政策》')
						return;
					}
			    	// 判断输入值
					if( !vm.account ){
						mui.toast('请输入账号');
						return;
					}
					
					if( !vm.password ){
						mui.toast('请输入密码');
						return;
					}
					
					// if(vm.account != "jyqytest" && vm.account != "yytest"){
					// 	if( !vm.phone ){
					// 		mui.toast('请输入手机号');
					// 		return;
					// 	}
						
					// 	var reg = new RegExp(/^1\d{10}$/);
					// 	if(!reg.test(vm.phone)) {
					// 		mui.toast("手机号格式错误");
					// 		return;
					// 	}
					// }
					
					
					
					if( !vm.code ){
						mui.toast('请输入图形验证码');
						return;
					}
					
					if(!vm.picNumber){
						mui.toast('请输入图片验证码');
						return;
					}
					
					if( vm.code != vm.picNumber.toLowerCase() ){
						mui.toast('图片验证码错误');
						return;
					}
					
					// if(vm.account != "jyqytest" && vm.account != "yytest"){
					// 	if(!vm.smsNumber){
					// 		mui.toast('请输入短信验证码');
					// 		return;
					// 	}
					// 	if( !vm.confirmPhone){
					// 		mui.toast('还未获取短信验证码');
					// 		return;
					// 	}
						
					// 	if(vm.phone != vm.confirmPhone){
					// 		mui.alert('输入手机号与接收短信验证码手机号不一致，请用当前手机号重新获取短信验证码','提示','确认',function (e) {
					// 		   e.index
					// 		});
					// 		return;
					// 	}
					// }
					
					
					var params = {
						account:vm.account,
						password:vm.password,
						// phone:vm.phone,
						// smsCode:vm.smsNumber,
						deviceId : mui.getUuid(),
						clientId : plus.storage.getItem('clientid') != null ? plus.storage.getItem('clientid') : ''
					};
					
					
					plus.nativeUI.showWaiting();
					var res = mui.http_post(API.LOGIN,params);
					plus.nativeUI.closeWaiting();
					res.then(res=>{
						if(res.code == 200){
							mui.toast('登录成功');
							//设置本地数据缓存
							plus.storage.setItem('accountInfo',JSON.stringify(res.data));
							setTimeout(function(){
								new_back();
							},800);
						}else{
							mui.toast(res.message);
							return;
						}
					})
					
				})
			})
			
			
		</script>
	</body>

</html>
