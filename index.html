<!DOCTYPE html>
<html>

	<head> 
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>首页</title>
		<script type="text/javascript">
			document.write('<script src="js/fix.js?rd=?rd=' + Math.random() + '"><\/script>');
		</script>
		
		<script type="text/javascript">
			link(['css/mui.min.css','css/iconfont.css','css/icon.css','css/common.css','css/animate.css','css/index/index.css'],true);
		</script>
	 
	</head>
 
	<body>
		<div class="mui-content" id="app">
			<!-- 实用查询 -->
			<div class="catelog-box">
				
				<div class="catelog-item" id="to-net-drug">
					<div class="catelog-log iconfont1 icon-guawang"></div>
					<div class="catelog-name">挂网药品</div>
				</div>
				
				<div class="catelog-item" data-href="http://drugs.dxy.cn" data-title="药品说明书" id="drug-description">
					<div class="catelog-log iconfont1 icon-shuomingshu"></div>
					<div class="catelog-name">药品说明书</div>
				</div>
				
				<div class="catelog-item" data-href="https://db.yaozh.com/basicdir" data-title="基本药物目录" id="essential-drug">
					<div class="catelog-log iconfont1 icon-jiyao"></div>
					<div class="catelog-name">基药目录</div>
				</div>
				
				<div class="catelog-item" id="more">
					<div class="catelog-log iconfont1" :class="more ? ' icon-shouqi' : ' icon-gengduo' "></div>
				</div>
				
					
				<div v-show="more" class="catelog-item catelog-url" data-href="http://cdsylbz.chengdu.gov.cn/ebaowx/html/mi.html" data-title="医保目录查询">
					<div class="catelog-log iconfont1 icon-jibao"></div>
					<div class="catelog-name">医保目录</div>
				</div>
				
				<div v-show="more" class="catelog-item" data-href="http://drugs.dxy.cn/index.htm" data-title="用药指南" id="medication-guide">
					<div class="catelog-log iconfont1 icon-yongyaozhinan"></div>
					<div class="catelog-name">用药指南</div>
				</div>
				
				<div v-show="more" class="catelog-item" id="four-and-seven">
					<div class="catelog-log iconfont1 icon-sijiaqi"></div>
					<div class="catelog-name">4+7品种</div>
				</div>
				
				<div v-show="more" class="catelog-item" style="background: transparent;">
				</div>	
				
				
			</div>
			
			<!-- 轮播图 -->
			<div class="banner-box">		
				<div class="mui-slider" id="slider">
					  <div class="mui-slider-group mui-slider-loop">
						  <!-- 最后一张 -->
							<div class="mui-slider-item mui-slider-item-duplicate">
								<img class="slide-img" src="images/banner3.png" >
							</div>
						
							<div class="mui-slider-item">
								<img class="slide-img" src="images/banner.png" >
							</div>
							<div class="mui-slider-item">
								<img class="slide-img" src="images/banner1.png" >
							</div>
							<div class="mui-slider-item">
								<img class="slide-img" src="images/banner2.png" >
							</div>
							<div class="mui-slider-item">
								<img class="slide-img" src="images/banner3.png" >
							</div>
							<!-- 第一张 -->
							<div class="mui-slider-item mui-slider-item-duplicate">
								<img class="slide-img" src="images/banner.png" >
							</div>
						
					  </div>
				  
					  <div class="mui-slider-indicator">
						  <div class="mui-indicator mui-active"></div>
						  <div class="mui-indicator"></div>
						  <div class="mui-indicator"></div>
						  <div class="mui-indicator"></div>
					  </div>
				</div>
			</div>
			<!-- 通知栏 -->
			<div class="notice-box">
				<div class="notice-content">
					<span class="iconfont icon-tongzhi"></span>&nbsp;<span id="notice" class="notice-title animated"></span>
				</div>
				<div class="notice-more"></div>
			</div>
			
			<div class="divided-module"></div>
			
			<div class="nav-title">药品两票</div>
			<ul class="mui-table-view mui-grid-view mui-grid-9" id="drug">
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
					<a href="javascript:void(0)" data-href="html/drug/net-drug.html">
						<span class="mui-icon iconfont icon--liuchengguanli"></span>
						<div class="mui-media-body">挂网药品</div>
					</a>
				</li>
				 
				<!-- 经营企业 -->
				<template v-if="accountInfo.roleid == 6 ? true : false">
					<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
						<a href="javascript:void(0)" data-href="html/drug/com-drug.html">
							<span class="mui-icon iconfont icon-shengdanjieicon-"></span>
							<div class="mui-media-body">本企药品</div>
						</a>
					</li>
					<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
						<a href="javascript:void(0)" data-href="html/warehouseinto/index.html">
							<span class="mui-icon iconfont icon-jiashu"></span>
							<div class="mui-media-body">票据入库</div>
						</a>
					</li>
					<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
						<a href="javascript:void(0)" data-href="html/warehouseout/index.html">
							<span class="mui-icon iconfont icon-jianshu"></span>
							<div class="mui-media-body">票据出库</div>
						</a>
					</li>
					
				</template>
				 
				<!-- 临床科室 -->
				<template v-if="accountInfo.roleid == 11 ? true : false">
					<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
						<a href="javascript:void(0)" data-href="html/drug/hos-drug.html">
							<span class="mui-icon iconfont icon-shengdanjieicon-"></span>
							<div class="mui-media-body">本院药品</div>
						</a> 
					</li>
				</template>
				
				<!-- 医疗机构 -->
				<template v-if="accountInfo.roleid == 7 ? true : false">
					<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
						<a href="javascript:void(0)" data-href="html/drug/hos-drug.html">
							<span class="mui-icon iconfont icon-shengdanjieicon-"></span>
							<div class="mui-media-body">本院药品</div>
						</a>
					</li>
					<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
						<a href="javascript:void(0)" data-href="html/drug/check-ticket.html">
							<span class="mui-icon iconfont icon--jiandinggujia"></span>
							<div class="mui-media-body">票据查验</div>
						</a>
					</li>

				</template>
				
			 
			</ul>
			
			<div class="nav-title">检验报告</div>
			<ul class="mui-table-view mui-grid-view mui-grid-9" >
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3" >
					<a href="javascript:void(0)" data-href="html/report/index.html" id="report">
						<span class="mui-icon iconfont icon--biaodanguanli"></span>
						<div class="mui-media-body">药检报告</div>
					</a>
				</li>
			</ul>
			
			<div class="nav-title">药品采购</div>
			<ul  class="mui-table-view mui-grid-view mui-grid-9" >
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3" >
					<a href="javascript:void(0)" data-href="html/short/index.html" id="short">
						<span class="mui-icon iconfont icon-xuqiu"></span>
						<div class="mui-media-body">短缺药品</div>
					</a>
				</li>
			</ul>
			
			<div class="divided-module"></div> 
			<!-- 
			<div class="nav-title">新药申报</div>
			<ul class="mui-table-view mui-grid-view mui-grid-9">
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3" id="push-test">
					<a href="javascript:void(0)">
						<span class="mui-icon iconfont icon--gonggaoguanli"></span>
						<div class="mui-media-body">申报通知</div>
					</a>
				</li>
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
					<a href="#">
						<span class="mui-icon iconfont icon--cangpindengbian"></span>
						<div class="mui-media-body">发布通知</div>
					</a>
				</li>
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
					<a href="#">
						<span class="mui-icon iconfont icon--suoyouzhengji"></span>
						<div class="mui-media-body">本院发布</div>
					</a>
				</li>
			</ul>
			
			<div class="nav-title">电子首营</div>
			<ul class="mui-table-view mui-grid-view mui-grid-9">
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
					<a href="#">
						<span class="mui-icon iconfont icon--cangpinyijiao"></span>
						<div class="mui-media-body">首营交换</div>
					</a>
				</li>
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
					<a href="#">
						<span class="mui-icon iconfont icon-xiangshang2"></span>
						<div class="mui-media-body">我的请求</div>
					</a>
				</li> 
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
					<a href="#">
						<span class="mui-icon iconfont icon-xiangxia2"></span>
						<div class="mui-media-body">客户请求</div>
					</a>
				</li>
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
					<a href="#">
						<span class="mui-icon iconfont icon--shoucangzheguanli"></span>
						<div class="mui-media-body">客户资料库</div>
					</a>
				</li>
				<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-3">
					<a href="#">
						<span class="mui-icon iconfont icon--jiaoseguanli"></span>
						<div class="mui-media-body">我的首营</div>
					</a>
				</li>
			</ul>
			 -->
			
			<!-- 新闻版块 -->
			<div class="title-box">
				<div class="news-title">新闻资讯 <span class="news-subtitle">实时掌握行业信息</span></div>
				<div class="more" id="news-more">更多 &gt;&gt;</div>
			</div>
			
			<template v-for="(item,index) in newsData">
				<div class="news-box" :data-index="index">
					<div class="news-left">
						<div class="news-name">{{item.title}}</div>
						<div class="news-date">{{item.create_time}}</div>
					</div>
					<div class="news-right">
						<img :src="item.cover" onerror="this.src='./images/60x60.gif'"/>
					</div>
				</div>
			</template>
			
			
			<!-- <div class="divided-module"></div> -->
			
		</div>

		<script type="text/javascript">
			script(['js/mui.min.js','js/vue.js','js/util.js','js/api.js','js/lib/permission.js','js/app.js']);
		</script>
		
		<script type="text/javascript">
			// vue实例挂载
			var vm = new Vue({
				el:'#app', 
				data:{
					accountInfo:'',
					currentIndex : 1,
					newsData : [],
					more : false,
				}
			});
			
			
			(function() {
				
				mui.init({
					swipeBack: false,
					pullRefresh : {
						container:"#app",
						down : {
							style:'circle',
							color:'#3383FC', 
							height:'50px',
							range:'100px', 
							offset:'0px', 
							auto: false,
							callback :function(){
								getNews();
								mui('#app').pullRefresh().endPulldown();
							}
					    },
					}
				});
				
				
				
				var loadView = function(){
					var accountInfo = plus.storage.getItem('accountInfo');
					if(accountInfo != null){
						vm.accountInfo = JSON.parse( accountInfo );
					}else{
						vm.accountInfo = '';
					}
				}
				
				// 获取新闻
				function getNews(){ 
					let news = mui.http_post(API.GET_NEWS,{num : 3});
					news.then(data=>{
						if(data.code == 200){
							vm.newsData = data.data.data;
						} 
					});
					
				}
				
				document.addEventListener("plusready",function() {
					
					mui.appUpdate();
					
					mui.setMyId();
					
					// 获取设备clientid并存储
					mui.getClientId();
					
					// 实用查询-更多
					mui('.catelog-box').on('tap','#more',function(){
						mui.notice()
						let more = vm.more;
						vm.more = !more;
					});
					
					// 实用查询
					// 挂网药品
					mui('.catelog-box').on('tap','#to-net-drug',function(){
						mui.openWindow({
							 url:'html/drug/net-drug.html',
							 id:'html/drug/net-drug.html',
							 show:{
								 autoShow:true,
							 }
						});
					});
					// 药品说明书
					mui('.catelog-box').on('tap','#drug-description',function(){
						mui.openWindow({
							 url:'html/drug/drug-description.html',
							 id:'html/drug/drug-description.html',
							 show:{
								 autoShow:true,
							 }
						});
					})
					
					//查询基药目录
					mui('.catelog-box').on('tap','#essential-drug',function(){
						 mui.openWindow({
						 	 url:'html/drug/essential-drug.html',
						 	 id:'html/drug/essential-drug.html',
						 	 show:{
						 		 autoShow:true,
						 	 }
						 });
					 })
					
					//查询用药指南
					mui('.catelog-box').on('tap','#medication-guide',function(){
						mui.openWindow({
							 url:'html/drug/medication-guide.html',
							 id:'html/drug/medication-guide.html',
							 show:{
								 autoShow:true,
							 }
						});
					})
					
					// 4+7
					mui('.catelog-box').on('tap','#four-and-seven',function(){
						mui.openWindow({
							 url:'html/drug/four-seven-drug.html',
							 id:'html/drug/four-seven-drug.html',
							 show:{
								 autoShow:true,
							 }
						});
					})
					
					
					//监听系统通知栏消息点击事件  
					plus.push.addEventListener('click', function(msg){
						var payload = typeof(msg.payload) != 'string' ? msg.payload : JSON.parse(msg.payload);
						var type = payload.type;
						// 判断是否登录
						var accountInfo = plus.storage.getItem('accountInfo');
						
						switch(type){
							case 'chat':
								mui.openWindow({
									url:"html/my/customer-chat.html",
									id:"html/my/customer-chat.html",
									extras:{
										toInfo:{
											id : payload.fromid,
											name : payload.username,
											avatar : payload.avatar
										}
									}
								});
								break;
							
							case 'useradd':
								if( accountInfo == null ){
									mui.toast('请先登录');
									return;
								}
								mui.openWindow({
									url : 'html/user/new-friend.html',
									id : 'html/user/new-friend.html',
									show:{
										autoShow:false,
									}
								});
								break;
								
							case 'short':
								if( accountInfo == null ){
									mui.toast('请先登录');
									return;
								}
								mui.trigger(document.getElementById('short'),'tap');
								break;
								
							default:
								break;
						}
						
						
					}, false);
					
					//接收透传消息
					plus.push.addEventListener('receive',function(msg){
						// alert(JSON.stringify(msg));
						var content = msg.content;
						var payload = JSON.parse(msg.payload);
						
						if(mui.os.ios && payload.mark == undefined){
							//苹果系统,服务器推送过来的 则创建本地消息
							payload.mark = true;
							plus.push.createMessage(content, JSON.stringify(payload),{title : msg.title});
						}
						
					},false)
					
					// 直接将app后台运行
					mui.back = function(){
						var main = plus.android.runtimeMainActivity();
						main.moveTaskToBack(false); 
					}
				
					
					loadView();
					
					// 自动banner轮播
					 var slider = mui("#slider");
					 slider.slider({
						interval: 1000
					 });
						
					// 通知文字轮播
					var noticeArr = ['药械e家APP上线啦','药品票据电子化的时代已来临'];
					var title = document.getElementById('notice'),index = 0;
					var myset = setInterval(function(){
						var count = noticeArr.length;
						if(index <= count-1){
							title.innerText = '';
							title.classList.remove('slideInUp');
							title.innerText = noticeArr[index];
							title.classList.add('slideInUp');
							++index;
						}else{
							index = 0;
						}
						
					},1200)
					
					//网络错误监听
					mui.networkError();
					
					var self = plus.webview.currentWebview();
					
					// 监听首页show事件
					self.addEventListener('show',function(){
						loadView();
					})
					
					//监听登录/退出后重载
					window.addEventListener('loginLoad',function(){
						mui.updateMessCount(true,false);
						loadView();

					})
					
					
					// 创建子webview窗口 并初始化 
					var aniShow = {};
					util.initSubpage(aniShow);
					
					// 消息总数提示 
					mui.updateMessCount(true,false);
					var nview = plus.nativeObj.View.getViewById('tabBar'),
						activePage = plus.webview.currentWebview(),
						targetPage,
						subpages = util.options.subpages,
						pageW = window.innerWidth,
						currIndex = 0;
						
					/**
					 * 根据判断view控件点击位置判断切换的tab
					 */
					nview.addEventListener('click', function(e) {
						var clientX = e.clientX;
						if(clientX > 0 && clientX <= parseInt(pageW * 0.25)) {
							currIndex = 0;
						} else if(clientX > parseInt(pageW * 0.25) && clientX <= parseInt(pageW * 0.5)) {
							currIndex = 1;
						} else if(clientX > parseInt(pageW * 0.5) && clientX <= parseInt(pageW * 0.75)) {
							currIndex = 2;
						}else if(clientX > parseInt(pageW * 0.75) && clientX <= parseInt(pageW *1)){
							currIndex = 3;

						}
						// 匹配对应tab窗口	
						if(currIndex > 0) {
							targetPage = plus.webview.getWebviewById(subpages[currIndex - 1]);
						} else {
							targetPage = plus.webview.currentWebview(); //首页
							//mui.fire(targetPage,'show');
						}

						if(targetPage == activePage) { 
							return;
						}
						
							//底部选项卡切换
							util.toggleNview(currIndex);
							// 子页面切换
							util.changeSubpage(targetPage, activePage, aniShow);
							//更新当前活跃的页面
							activePage = targetPage;
							
							// 更新标题栏
							util.updateTitleNView(currIndex);
							
					});
					
					var targetNav;
					// 药品两票菜单点击
					mui('#drug').on('tap','a',function(e){
						 targetNav = this.dataset.href;
						
						// 判断网络情况
						var type = plus.networkinfo.getCurrentType();
						if( [0,1].indexOf(type) != -1 ){
							mui.alert('网络异常，请确认网络情况','提示','确认',function (e) {
							   e.index
							});
							return;
						}
						 
						 mui.openWindow({
							 url:targetNav,
							 id:targetNav,
							 show:{
								 autoShow:true,
							 }
						 });
						
					});
					
					// 短缺药品采购
					document.getElementById('short').addEventListener('tap',function(e){
						var href = this.dataset.href;
						var accountInfo = plus.storage.getItem('accountInfo');
						if(accountInfo == null){
							mui.alert('请先登录','提示','确认',function (e) {});
							return;
						}
						if( '6,7'.indexOf(JSON.parse(accountInfo).roleid) == -1 ){
							mui.alert('该角色无权限','提示','确认',function (e) {});
							return;
						}else{
							mui.openWindow({
								 url:href,
								 id:href,
								 show:{
									 autoShow:true,
								 }
							});
						}
					})
					
					
					// 打开药检报告
					document.getElementById('report').addEventListener('tap',function(e){
						var href = this.dataset.href;
						var accountInfo = plus.storage.getItem('accountInfo');
						if(accountInfo == null){
							mui.alert('请先登录','提示','确认',function (e) {});
							return;
						}
						if( '6,7,9'.indexOf(JSON.parse(accountInfo).roleid) == -1 ){
							mui.alert('该角色无权限','提示','确认',function (e) {});
							return;
						}else{
							mui.openWindow({
								 url:href,
								 id:href,
								 show:{
									 autoShow:true,
								 }
							});
						}
					})
					
					// 使用查询
					mui('.catelog-box').on('tap','.catelog-url',function(){
						var href = this.dataset.href;
						var title = this.dataset.title;
						var win = 'html/search-tool/embed.html';
						// 创建窗口
						var ws = plus.webview.create(win,win,{scrollIndicator :'none',scalable : false,backButtonAutoControl : 'close',},{title,href})
						ws.show('pop-in');
					})
					
					// 获取最新3条新闻
					getNews()
					
					// 查看新闻更多
					document.getElementById('news-more').addEventListener('tap',function(){
						mui.openWindow({
							url : 'html/news/news-more.html',
							id : 'html/news/news-more.html',
							show : {
								autoShow:true
							} 
						})
					})
					
					//新闻详情页
					 mui('#app').on('tap','.news-box',function(){
						 let index = this.dataset.index;
						 let news = vm.newsData[index];
						 mui.openWindow({
							 url : 'html/news/news-detail.html',
							 id : 'html/news/news-detail.html',
							 show:{
								 autoShow : true
							 },
							 extras : {
								title : news.title,
								conver : news.cover,
								time : news.create_time,
								content : news.content
							 }
						 })
					 })
					
				},false);
			})();
		</script>
	</body>

</html>